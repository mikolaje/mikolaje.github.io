<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/cat_favicon_32.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/cat_favicon_16.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="Hi, I am Dennis, being as a data engineer for several years. I am enthusiastic about programming (Python and Java), studying and making money. Regarding entertainments, I enjoy playing badminton and t">
<meta property="og:type" content="website">
<meta property="og:title" content="Welcome to Dennis Blog">
<meta property="og:url" content="http://mikolaje.github.io/index.html">
<meta property="og:site_name" content="Welcome to Dennis Blog">
<meta property="og:description" content="Hi, I am Dennis, being as a data engineer for several years. I am enthusiastic about programming (Python and Java), studying and making money. Regarding entertainments, I enjoy playing badminton and t">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Welcome to Dennis Blog">
<meta name="twitter:description" content="Hi, I am Dennis, being as a data engineer for several years. I am enthusiastic about programming (Python and Java), studying and making money. Regarding entertainments, I enjoy playing badminton and t">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://mikolaje.github.io/"/>





  <title>Welcome to Dennis Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Welcome to Dennis Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">欢迎各位领导前来指导工作</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mikolaje.github.io/2019/tmux_guide.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dennis">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Welcome to Dennis Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/tmux_guide.html" itemprop="url">Tmux简明教程</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-02T12:07:10+08:00">
                2019-09-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tmux/" itemprop="url" rel="index">
                    <span itemprop="name">tmux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/tmux_guide.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/tmux_guide.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>你经常可能会遇到这样的情况：你在vim编辑你在远程服务器上面的代码，然后你要新开一个窗口再次ssh到<br>这个远程服务器来测试运行你的代码。此外，如果你的WIFI断线了，你的所有session都会挂掉，GG。<br>然后你又要麻烦地重新开两个session。</p>
<p>其实，上述问题都可以用tmux解决，一个可以提供如下功能的命令行工具：</p>
<ol>
<li>在一个terminal window内开启多个windows，panes。</li>
<li>在一个session内(这个session会一直保持着，即使断网的时候也会保持着)保持windows和panes。</li>
<li>能够共享session(这功能对结对编程来说真是太妙了！)，就是说，你在session上做得所有操作，<br>在另一台电脑上连接到同一个session，会看到同样的输入和输出。</li>
</ol>
<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>Ubuntu用户只需要执行<code>sudo apt-get install tmux</code><br>Mac 用户只需要执行<code>brew install tmux</code></p>
<p>安装完后，执行如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tmux</div></pre></td></tr></table></figure></p>
<p><img src="/images/2019/tmux_guide/1dec3830.png" alt=""><br>这看起来和普通的终端差不多，除了底下有条绿色的状态bar。在这个bar上，我们可以运行tmux命令去控制管理终端windows和sessions</p>
<h3 id="Tmux基本命令："><a href="#Tmux基本命令：" class="headerlink" title="Tmux基本命令："></a>Tmux基本命令：</h3><p>当你进入到tmux后，你可以通过先运行一个prefix key来执行各种命令。默认来说，tmux的prefix key是 ctrl + b。也就是说在执行<br>其他任何命令之前你都要先同时按下ctrl + b。 </p>
<p>tmux的命令有很多很多，但首先我们了解下基本的就好了，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;prefix&gt; c: 创建一个新的window（在status bar中显示）</div><div class="line">&lt;prefix&gt; 0: 切换到 window 0</div><div class="line">&lt;prefix&gt; 1: 切换到 window 1</div><div class="line">&lt;prefix&gt; 2: 切换到 window 2 (etc.)</div><div class="line">&lt;prefix&gt; x: Kill 当前的window </div><div class="line">&lt;prefix&gt; w: 切换 window</div><div class="line">&lt;prefix&gt; d: detach 到tmux（也就是说当你离开后，再次回到session中）</div></pre></td></tr></table></figure></p>
<p>如果你把在tmux session的所有的window都kill后，它将会kill整个session并且回到普通的终端上。<br>如果你用<prefix> d 去 detach到tmux，你将会回到你的tmux session，而且你可以看到你之前运行的东西已然在那里。<br>要查看所有的tmux sessions，你可以使用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tmux ls</div></pre></td></tr></table></figure></prefix></p>
<p>要attach到最后一个使用的session，你可以用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tmux a</div></pre></td></tr></table></figure></p>
<p>要attach到指定的某个session，你可以用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tmux a -t &lt;session-name&gt;</div></pre></td></tr></table></figure></p>
<p>这里补充说明下 session 和 window之间的关系，我们看看这个图，<br>一个window相当于你的显示器能看到的所有东西，然后一个window上可以分成一块块的拼图，也就是各个panes：<br><img src="/images/2019/tmux_guide/5a861515.png" alt=""></p>
<p>这就这么一些。现在你可以通过多个终端window和永久的sessions来在你的远程电脑上工作了。<br>你甚至可以通过让两个人attach到同一个session来进行结对编程！</p>
<h3 id="下一步"><a href="#下一步" class="headerlink" title="下一步"></a>下一步</h3><p>上面的命令对掌握tmux真的非常有用。通常，我尽量少开窗口，一般是一个window用于vim，另一个window做开发，第3个窗口去运行命令。<br>大多数人倾向于用panes来在同一个屏幕上展现多个内容。</p>
<p>Panes是个特别炫酷的东西而且很值得学习，但是推荐你们先放一放，不要急着学习太多panes的东西，因为它会增加你的tmux学习曲线。<br>当你用panes时候，你要记住水平和垂直创建panes的命令，还有切换不同panes的命令，还有改变panes大小，关闭panes的命令，等等等等。<br>所以我建议先把其它的玩熟练再去用panes这些花哨的东西。</p>
<p>你也可以通过在home目录下添加<code>.tmux.conf</code>文件来指定tmux的一些配置。<br>比如通常可以在里面改变 prefix的快捷键（很多人会使用ctrl+a 作为prefix）。<br>初始window数设置为1，而不是0;然后还可以设置下颜色。<br>如果你打算重新绑定prefix，很有可能这将会为你以后形成肌肉记忆了，哈哈。</p>
<p>下面是一个精简版的.tmux.conf, 只改变了window数和 prefix:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># remap prefix from &apos;C-b&apos; to &apos;C-a&apos;</div><div class="line">unbind C-b</div><div class="line">set-option -g prefix C-a</div><div class="line">bind-key C-a send-prefix</div><div class="line"># Start window numbering at 1</div><div class="line">set -g base-index 1</div><div class="line"></div><div class="line"># 建议加上这个，用鼠标会有很大惊喜，呵呵。在多个panes的时候切换用鼠标点一下就好了！</div><div class="line"># 同时也解决了scroll的问题，可以轻松地用鼠标在不同的panes内滚动！</div><div class="line">set -g mouse on</div></pre></td></tr></table></figure></p>
<p>tmux有非常多的可选配置，但是你得由浅到深，刚开始尽可能精简。当你想尝试一些更高级的功能时，不要在网上复制粘贴。<br>你必须清楚<code>.tmux.conf</code>的每一个配置的作用是什么。</p>
<p>一旦你感觉你掌握了基础，将会有很多好玩的高级tmux游戏等着你。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mikolaje.github.io/2019/hexo_seo.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dennis">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Welcome to Dennis Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/hexo_seo.html" itemprop="url">Hexo博客SEO优化，添加robots.txt</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-30T11:55:10+08:00">
                2019-07-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SEO/" itemprop="url" rel="index">
                    <span itemprop="name">SEO</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SEO/hexo/" itemprop="url" rel="index">
                    <span itemprop="name">hexo</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/hexo_seo.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/hexo_seo.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近一时兴起，想提高自己博客的点击率，就尝试做了一些SEO优化，并且加入了Google Adsense广告。呵呵，<br>写博客这么辛苦，赚点钱是应该的嘛。</p>
<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>废话不说了，直接进入主题。都知道要想在百度搜索，Google搜索结果页中排得靠前，你得让人家的爬虫搜你嘛，<br>所以我们得通过一个叫<code>robots.txt</code>的文件放在根目录上。这文件的目的，就是告诉搜索引擎应该搜索我这网站的那些内容。<br>我们当然希望是搜索我们文章内容本身，不要去搜那些JavaScript和CSS代码。</p>
<h3 id="配置-robots-txt"><a href="#配置-robots-txt" class="headerlink" title="配置 robots.txt"></a>配置 robots.txt</h3><p>我们在hexo 根目录下的 <code>public</code> 目录下新建一个<code>robots.txt</code>文件，内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">User-agent: *</div><div class="line">Allow: /</div><div class="line">Allow: /archives/</div><div class="line">Allow: /categories/</div><div class="line">Allow: /tags/</div><div class="line">Allow: /about/</div><div class="line"></div><div class="line">Disallow: /vendors/</div><div class="line">Disallow: /js/</div><div class="line">Disallow: /css/</div><div class="line">Disallow: /fonts/</div><div class="line">Disallow: /fancybox/</div><div class="line"></div><div class="line">Sitemap: https://mikolaje.github.io/sitemap.xml</div><div class="line">Sitemap: https://mikolaje.github.io/baidu_sitemap.xml</div></pre></td></tr></table></figure></p>
<p>最后面两行是site-map</p>
<p>这里要注意的是如果js和fonts这些加了disallow的话，会出现谷歌抓取问题。<br><img src="/images/2019/hexo_seo/google_spyder.png" alt=""><br>因为现在（2019-09以后）Google Search默认是用智能手机引擎来抓取，<br>所以如果js和css这样被disallow的话会有问题，建议还是把上面的disallow去掉。</p>
<h3 id="Sitemap即网站地图"><a href="#Sitemap即网站地图" class="headerlink" title="Sitemap即网站地图"></a>Sitemap即网站地图</h3><p>它的作用在于便于搜索引擎更加智能地抓取网站。<br>最简单和常见的sitemap形式，是XML文件，在其中列出网站中的网址以及关于每个网址的其他元数据（上次更新时间、更新的频率及相对其他网址重要程度等）。</p>
<p>要使用<code>sitemap</code>我们需要安装两个hexo的插件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">npm install hexo-generator-sitemap --save</div><div class="line">npm install hexo-generator-baidu-sitemap --save</div></pre></td></tr></table></figure></p>
<p>然后，我们要在根目录下的<code>_config.yml</code> 的最后面添加如下内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="attr">sitemap:</span></div><div class="line"><span class="attr">  path:</span> sitemap.xml</div><div class="line"><span class="attr">baidusitemap:</span></div><div class="line"><span class="attr">  path:</span> baidusitemap.xml</div></pre></td></tr></table></figure>
<h3 id="配置ads-txt"><a href="#配置ads-txt" class="headerlink" title="配置ads.txt"></a>配置ads.txt</h3><blockquote>
<p>ads.txt是干什么用的？</p>
<p>授权数字卖方 (ads.txt) 是一项 IAB 计划，可帮助确保您的数字广告资源只通过您认定为已获得授权的卖家（如 AdSense）进行销售。创建自己的 ads.txt 文件后，您可以更好地掌控允许谁在您的网站上销售广告，并可防止向广告客户展示仿冒广告资源。</p>
</blockquote>
<p>在Google Adsense找到相应的页面下载 ads.txt，然后同样放在根目录的<code>public</code>目录下面。<br><img src="/images/2019/hexo_seo/adsense.png" alt=""></p>
<h3 id="修改博文链接"><a href="#修改博文链接" class="headerlink" title="修改博文链接"></a>修改博文链接</h3><p>HEXO默认的文章链接形式为<code>domain/year/month/day/postname</code>，默认就是四级url，并且可能造成url过长，对搜索引擎是不太不友好，<br>我们可以改成domain/postname 的形式。编辑站点的_config.yml文件，<br>修改其中的permalink字段改为<code>permalink: :title.html</code>即可。</p>
<blockquote>
<p>配置完成后，重新部署hexo：<code>hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</code></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mikolaje.github.io/2019/pyspark_slower.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dennis">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Welcome to Dennis Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/pyspark_slower.html" itemprop="url">PySpark 会比Scala或Java慢吗（译）？</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-04T12:07:10+08:00">
                2019-07-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/spark/" itemprop="url" rel="index">
                    <span itemprop="name">spark</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/pyspark_slower.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/pyspark_slower.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>首先，你必须知道不同类型的API（RDD API，MLlib 等），有它们不同的性能考虑。</p>
<h2 id="RDD-API"><a href="#RDD-API" class="headerlink" title="RDD API"></a>RDD API</h2><p>（带JVM编排的Python结构）</p>
<p>这是一个会被Python代码性能和PySpark实施影响最大的组件。虽然Python性能很可能不会是个问题，至少有几个因素你要考虑下：</p>
<ul>
<li><p>JVM 通信的额外开销。所有进出Python executor的数据必须通过一个socket和一个JVM worker. 尽管这过程相当高效，以为走的都是本地通信，<br>但多少依然还是要付出点代价。</p>
</li>
<li><p>基于进程的Python executor 对比基于线程（单JVM多线程）的 Scala executors。每个Python executor在它独自的进程里运行。<br>它的副作用是，虽然它有着比JVM更强的隔离性，并且对executor生命周期的一些控制也比JVM更强，但是潜在地会比JVM的executor消耗更多的内存。<br>比如：</p>
<ul>
<li>解析器内存footprint</li>
<li>加载模块的footprint</li>
<li>更低效的广播（因为每个进程需要独自的广播复制）</li>
</ul>
</li>
<li><p>Python本身的性能。总的来说Scala会比Python更快，但不同的task有有所不同。此外，你有其它的选项包括JITs<br>比如Numba，C扩展Cython或者其它专业的lib比如Theano。最后，可以考虑用PyPy作为解析器。</p>
</li>
<li><p>PySpark configuration提供<code>spark.python.worker.reuse</code>参数， 这可以用来对每个task在 forking Python进程和复用已有的进程中作出选择。<br>后者似乎在避免昂贵的垃圾回收方面上更有用（这更多的是一个印象而不是系统测试的结果）</p>
</li>
<li><p>在CPython里首选的垃圾回收方法，引用计数法，和典型的Spark 作业（比如流式处理，没有引用循环）结合得挺好，并且减少了长时间垃圾回收等待的风险。</p>
</li>
</ul>
<h2 id="MLlib"><a href="#MLlib" class="headerlink" title="MLlib"></a>MLlib</h2><p>（结合Python和JVM执行）</p>
<p>基本上要考虑的和前面说的那些差不多，这里再补充一些。尽管MLlib所用的基础架构是Python RDD，所有的算法都是直接用Scala来执行的。这意味着需要额外的开销来将Python 对象转为Scala对象，<br>增长的内存使用率和一些其它的限制我们将来再说。</p>
<p>现在的Spark2.x，基于RDD的API是以一个维护模式存在，Spark3.0计划会移除RDD API。</p>
<h2 id="DataFrame-API-和-Spark-ML"><a href="#DataFrame-API-和-Spark-ML" class="headerlink" title="DataFrame API 和 Spark ML"></a>DataFrame API 和 Spark ML</h2><p>（限制在driver的用Python代码的JVM执行）<br>这些可能是对标准数据处理task最好的选择。因为Python代码在driver端大多被限制在高层次的逻辑操作，在这方面上Scala和Python基本上没有什么区别。<br>有个例外是，按行的Python UDF相对来说会比Scala慢很多。尽管有很多改进的机会（在Spark2.0有着大量的改进），最大的限制还是JVM和Python解析器之间数据传送。</p>
<p>尽量习惯于用Spark内置的一些函数比如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">from pyspark.sql.functions import col, lower, trim</div><div class="line"></div><div class="line">exprs = [</div><div class="line">    lower(trim(col(c))).alias(c) if t == &quot;string&quot; else col(c) </div><div class="line">    for (c, t) in df.dtypes</div><div class="line">]</div><div class="line"></div><div class="line">df.select(*exprs)</div></pre></td></tr></table></figure></p>
<p>应该用Spark的lower而不是Python String的lower，这样做有几个好处：</p>
<ul>
<li>这操作直接将数据到JVM而不用到Python解析器</li>
<li>只需要投影一次，而不用对字段的每个字符串进行投影</li>
</ul>
<p>对了，避免在DataFrame和RDD之间的转换，因为这需要耗费很大的序列化和反序列化工作，更别说JVM和Python之间的数据传输了。</p>
<p>值得注意的是，调用Py4J会有非常高的延迟。这包括这样的调用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">from pyspark.sql.functions import col</div><div class="line"></div><div class="line">col(&quot;foo&quot;)</div></pre></td></tr></table></figure></p>
<p>通常，这不应该是个问题（overhead是固定的，不取决于数据量，但假如是实时程序，你可能考虑对 Java wrapper进行 缓存/复用 。</p>
<h2 id="GraphX-和-Spark-DataSets"><a href="#GraphX-和-Spark-DataSets" class="headerlink" title="GraphX 和 Spark DataSets"></a>GraphX 和 Spark DataSets</h2><p>对于 Spark 1.6 和 2.1，GraphX和Spark DataSets都不提供Python接口，所以你可以说PySpark比Scala差多了。</p>
<h3 id="GraphX"><a href="#GraphX" class="headerlink" title="GraphX"></a>GraphX</h3><p>实践里，GraphX开发几乎完全停滞了，项目目前在维护模式，在JIRA上一些tickets都已经关掉了，不再fix。GraphFrames库提供了Python结合，你可以选它作为一个 graph处理的办法。</p>
<h3 id="DataSets"><a href="#DataSets" class="headerlink" title="DataSets"></a>DataSets</h3><p>主观来说，Python在统计类型的DataSets没有什么空间，即使现有的Scala实施过于简单，并且不提供和DataFrame一样的性能优势。</p>
<h2 id="Streaming"><a href="#Streaming" class="headerlink" title="Streaming"></a>Streaming</h2><p>从我之前说来看，我都会强烈推荐Scala，而不是Python。未来如果PySpark在structured streams上得到支持的话，可能会改变，但是现在来说，还是为时过早。再者，基于RDD的API<br>在Databricks文档里（ 2017-03-03）已经被定为“streaming遗产”，所以，可以期许下在未来进行统一。</p>
<h2 id="非性能考虑"><a href="#非性能考虑" class="headerlink" title="非性能考虑"></a>非性能考虑</h2><h3 id="功能平等"><a href="#功能平等" class="headerlink" title="功能平等"></a>功能平等</h3><p>不是所有的Spark特性、功能在PySpark上都有。需要确保下你需要的那部分已经实现了，并且尝试了解可能的限制。</p>
<p>有点特别重要的是，当你使用MLlib，和其它类似的混合Context（比如在task里调用Java/Scala 方法)。公平来讲，一些PySpark API，比如mllib.linalg，提供比Scala更加复杂的方法。</p>
<h3 id="API设计"><a href="#API设计" class="headerlink" title="API设计"></a>API设计</h3><p>PySpark API的设计和Scala类似，并不那么Pythonic。 这意味着很容易地可以在两种语言之间切换，但同时，Python可能会变得难以理解</p>
<h3 id="架构的复杂性"><a href="#架构的复杂性" class="headerlink" title="架构的复杂性"></a>架构的复杂性</h3><p>PySpark数据处理流程相当复杂比起纯粹的JVM执行来说。PySpark程序非常难去debug或找出出错原因。此外，至少在基本对Scala和JVM总体的理解上是必须要有的。</p>
<h3 id="Spark2-0-及以后"><a href="#Spark2-0-及以后" class="headerlink" title="Spark2.0 及以后"></a>Spark2.0 及以后</h3><p>随着RDD API被冻结，正在进行迁移到DataSet API对Python用户同时带来机会和挑战。尽管高级层次部分的API用Python包装会容易很多，但更高级的直接被使用的可能性很低。</p>
<p>此外，在SQL的世界里，原生Python function依然是二等公民。但值得期待的是，在将来伴随着Apache Arrow序列化，Python的地位会提高（目前侧重仍然是数据收集，UDF序列化以及反序列化仍然是个长远的目标）。<br>对于那些Python代码依赖性很强的项目，还可以选择纯Python的框架，比如Dask或Ray等等，也挺有意思的。</p>
<h2 id="不必和其它比较"><a href="#不必和其它比较" class="headerlink" title="不必和其它比较"></a>不必和其它比较</h2><p>Spark DataFrame（SQL，DataSets）API提供了一个在PySpark程序里整合Java/Scala代码优雅的方式。<br>你可以用<code>DataFrames</code> 去输送数据给原生JVM代码，然后返回结果。<br>我已经在其它地方解释了我的看法 <a href="https://stackoverflow.com/q/31684842" target="_blank" rel="external">这里</a> ，你可以在这 <a href="https://stackoverflow.com/q/36023860/1560062" target="_blank" rel="external">https://stackoverflow.com/q/36023860/1560062</a> 找到一个Python-Scala的工作案例 。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mikolaje.github.io/2019/private_IDC.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dennis">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Welcome to Dennis Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/private_IDC.html" itemprop="url">自建家用服务器集群，打造一个私有云</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-02T22:07:10+08:00">
                2019-07-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/运维/" itemprop="url" rel="index">
                    <span itemprop="name">运维</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/private_IDC.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/private_IDC.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><h3 id="我的战神"><a href="#我的战神" class="headerlink" title="我的战神"></a>我的战神</h3><p>还记得17年的时候，那时深度学习刚火起来，幼稚的我居然打算往这个领域去研究（根本没有意识到这领域需要的数学功底要多深）。俗话说，工欲善其事，必先利其器，于是乎，<br>一股脑地跑到广州的岗顶那买了台神舟战神 超级本（GTX-1060）。当时，经常都听到东哥在提到GPU，CUDA，GTX1080提到这些关键词。哈，为什当时会选择买一台笔记本，而不是台式呢？</p>
<p>其实，当时页考虑过买台式的，但是，考虑到当时在外面租房子，台式机搬家不方便。于是就想搞一台显卡性能好的笔记本，但是，完全不知道台式机的1060和笔记本的1060完全不是一个概念，<br>虽然都要同一个型号。至于为什么要买神舟，而不是华硕，或者其它，很简单，—-因为它性价比高（其实不高，买回来不久就感觉上当了，买回来玩FIFA OL会经常卡卡的，小毛病很多，而且<br>偶尔还会蓝屏。。）</p>
<p>那时候7400左右的价格在岗顶那买回来，真正用它就用了一年的时间吧。后来，在今年5月份，我以3000的价格在闲鱼上低价卖了。<br><img src="/images/2019/private_IDC/IMG_3434.jpg" alt="Sample Image Added via Markdown"></p>
<h3 id="第一台组装台式机"><a href="#第一台组装台式机" class="headerlink" title="第一台组装台式机"></a>第一台组装台式机</h3><p>前面算是有点扯远了，不过也算是记录一下我早期的一些想法吧，正是有了曾经的各种因素，导致了我今天打算搭建私有集群的IDEA。在尝到了神舟笔记本的坑后，我意识到，其实买一台台式机的必要性。<br>台式机在散热，硬件稳定性上都明显强于笔记本，而且，性价比也挺高的。对了，对于购买台式机的一个很重要的因素是，17年到18年这段时间里，我在云服务上花了不少钱，刚开始在阿里云，<br>然后在Google Cloud上。陆陆续续大概花了有六七千块钱吧，也将近买一台机器的钱了。<br>18年年初，我跑去深圳华强北，组装了自己第一台组装机（华硕主板，16G内存，1T硬盘），不加显示器，一共5000多人民币。背回来立马装了ubuntu系统，顿时感到有了自己的服务器，那感觉就像<br>在外面租房久了，终于买了属于自己的房子，再也不要担心服务器没续费，登陆不上；再也不用担心资源不够用，要去计算云服务的成本和开支了。自己的机子想怎么扩展都行。</p>
<p>其实刚开始，由于技术原因，我并没有把它当做一台服务器在用，只是把它当成一台PC安装了一些自己熟悉的开发环境和软件。在配置了Ngrok后，基本上把它当成一台云服务器了，24小时运行着。<br>关于ngrok的配置我前面有一篇专门的文章有讲得很详细。</p>
<p>最近发现我的台式机风扇声音有点大（比起Dell T30来说），从长远来看，毕竟是要7*24 running的，考虑到耗电量和稳定性，还是服务器好啊。我打算将再购置<br>2台服务器。其实，服务器完全可以当PC来用，但PC不能当服务器来用。</p>
<h3 id="第一台真正的服务器"><a href="#第一台真正的服务器" class="headerlink" title="第一台真正的服务器"></a>第一台真正的服务器</h3><p>虽然我的台式机现在配置有32G内存，在安装了一些软件（Cloudera Manager， Elasticsearch）后，内存就不太够用了。我是做数据这一块的，平时也要用分布式的框架，像Hadoop生态圈的<br>所以组件。我非常需要有一个真正的分布式平台去练手，于是就有了我的第一台服务器————戴尔T30<br><img src="/images/2019/private_IDC/t30.jpg" alt="Sample Image Added via Markdown"></p>
<p>也是在华强北的赛格广场，3200买的。配置是E3-1225，16G DDR4，2T*2 带阵列。T30 我没理解错的话应该是戴尔服务器的入门版。我对服务器不太理解，刚入门，挺好奇的，只知道一般PC的CPU<br>是分I7，I5等等，服务器的CPU是E开头的。然后，服务器用的内存和PC用的也不一样，是不能共用的。</p>
<p>购机的时候和那些卖电脑的老板闲聊也学到了好多专业知识。别看他们穿着没有写字楼的白领干净，没有程序员工资高，<br>但他们对计算机硬件知识还是很有经验的。比如，老板跟我说，你知道磁盘是怎么运行的吗？他说并不是说高转速的磁盘就一定好，如果突然断电的话，<br>转速高的磁盘容易被划伤。并介绍了下SAS，SATA，SSD之间的一些区别。他说SAS这种算是比较老的格式了。现在基本都用SATA。</p>
<p>那天我看了两种服务器，一种是机架式服务器，另一种是踏实。机架式的风扇声比较大（虽然单路的会比双路的小一些，但比起塔式服务器会大挺多的。）</p>
<h4 id="坑人的阵列卡"><a href="#坑人的阵列卡" class="headerlink" title="坑人的阵列卡"></a>坑人的阵列卡</h4><p>作为一个服务器装机菜鸟，我从网上下好的ubuntu服务器放在U盘里，然后改好U盘启动引导，开始安装。前几步没有啥问题，但到了选择安装磁盘路径的时候，找不到任何磁盘，<br>从而无法点击下一步继续。后来在老板的指导下，我才得知，原来是因为有阵列卡，BIOS没有设置对还是啥的，所以才读不到磁盘。于是，我在老板的远程指导下成功地拆卸掉阵列卡，<br>并重新接线好两块磁盘。之后，便正常地顺利正常地安装好ubuntu server了。</p>
<p><img src="/images/2019/private_IDC/raid.jpg" alt="Sample Image Added via Markdown"></p>
<h4 id="交换机"><a href="#交换机" class="headerlink" title="交换机"></a>交换机</h4><p>哈哈，没钱买千兆网卡，千兆交换机，只能用路由器充当了。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>玩硬件组装也是个超级无底洞，各个部件都可以扩展起来，内存，硬盘，CPU，可以水平扩展，也可以横向扩展。以后准备好好赚钱升级设备吧。如果比较缺钱的话可以上淘宝或闲鱼买点二手的配件，<br>比如内存条，硬盘这些。最好是可以和个人卖家交易，因为个人的话经常可以买到一些物美价廉的二手物品。另外，V2EX网站也有专门二手转让的版块，可以去看看。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mikolaje.github.io/2019/sqlalchemy_with_multiprocess.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dennis">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Welcome to Dennis Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/sqlalchemy_with_multiprocess.html" itemprop="url">SQLAchemy的多进程实践</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-02T12:07:10+08:00">
                2019-07-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/sqlalchemy_with_multiprocess.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/sqlalchemy_with_multiprocess.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近上头说我写的ETL工具从MySQL导出为CSV的速度太慢了，需要性能优化。的确，有部分数据因为在MySQL里面做了<br>分表分库，而我目前的导出实现是一个一个对小表进行导出。其实，这一步完全是可以并发多个表同时导出的。<br>理论上如果网络IO没有瓶颈的话，多个表同时从MySQL里dump可以大大提升效率。</p>
<h2 id="正题"><a href="#正题" class="headerlink" title="正题"></a>正题</h2><h3 id="查阅文档"><a href="#查阅文档" class="headerlink" title="查阅文档"></a>查阅文档</h3><p>为了实现并发地使用sqlalchemy我花了不少时间在网上找资料，也在StackOverflow寻求帮助。<br>其实刚开始我是想用threading结合SQLAlchemy来实现多线程导出的。去SQLAlchemy官网一看，没有找到相关的实现文档，<br>却找到了multiprocessing与SQLAlchemy的实践:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Using Connection Pools with Multiprocessing</div><div class="line">It’s critical that when using a connection pool, and by extension when using an Engine created via create_engine(), that the pooled connections are not shared to a forked process. TCP connections are represented as file descriptors, which usually work across process boundaries, meaning this will cause concurrent access to the file descriptor on behalf of two or more entirely independent Python interpreter states.</div><div class="line"></div><div class="line">There are two approaches to dealing with this.</div><div class="line"></div><div class="line">The first is, either create a new Engine within the child process, or upon an existing Engine, call Engine.dispose() before the child process uses any connections. This will remove all existing connections from the pool so that it makes all new ones. Below is a simple version using multiprocessing.Process, but this idea should be adapted to the style of forking in use:</div></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">engine = create_engine(<span class="string">"..."</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_in_process</span><span class="params">()</span>:</span></div><div class="line">  engine.dispose()</div><div class="line"></div><div class="line">  <span class="keyword">with</span> engine.connect() <span class="keyword">as</span> conn:</div><div class="line">      conn.execute(<span class="string">"..."</span>)</div><div class="line"></div><div class="line">p = Process(target=run_in_process)</div></pre></td></tr></table></figure>
<h3 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h3><p>于是，我就打算用multiprocessing试试了。multiprocessing有个比较坑爹的地方就是它会用pickle来序列化一些数据，<br>因为要把数据复制到新spawn出来的进程。</p>
<h4 id="关于pickle"><a href="#关于pickle" class="headerlink" title="关于pickle"></a>关于pickle</h4><p>首先我们要了解下pickle，虽然pickle挺坑的。哪些内容可以pickle呢，官网上说：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">What can be pickled and unpickled?</div><div class="line">The following types can be pickled:</div><div class="line"></div><div class="line">None, True, and False</div><div class="line"></div><div class="line">integers, floating point numbers, complex numbers</div><div class="line"></div><div class="line">strings, bytes, bytearrays</div><div class="line"></div><div class="line">tuples, lists, sets, and dictionaries containing only picklable objects</div><div class="line"></div><div class="line">functions defined at the top level of a module (using def, not lambda)</div><div class="line"></div><div class="line">built-in functions defined at the top level of a module</div><div class="line"></div><div class="line">classes that are defined at the top level of a module</div><div class="line"></div><div class="line">instances of such classes whose __dict__ or the result of calling __getstate__() is picklable (see section Pickling Class Instances for details).</div></pre></td></tr></table></figure></p>
<p>比如, 我们举个简单的例子：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</div><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">import</span> pymysql</div><div class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</div><div class="line"><span class="comment">#engine = create_engine(f'mysql+pymysql://root:ignorance@localhost:3306/', server_side_cursors=True, pool_size=20)</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Client</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment">#self.engine = create_engine(f'mysql+pymysql://root:ignorance@localhost:3306/', server_side_cursors=True, pool_size=20)</span></div><div class="line">        self.pool = Pool(<span class="number">5</span>)</div><div class="line">        self.connection = pymysql.connect(host=<span class="string">'localhost'</span>,</div><div class="line">                             user=<span class="string">'root'</span>,</div><div class="line">                             password=<span class="string">'ignorance'</span>,</div><div class="line">                             port=<span class="number">3306</span>,</div><div class="line">                             charset=<span class="string">'utf8mb4'</span>,</div><div class="line">                             cursorclass=pymysql.cursors.DictCursor)</div><div class="line">        self.engine = create_engine(f<span class="string">'mysql+pymysql://root:ignorance@localhost:3306/'</span>, server_side_cursors=<span class="keyword">True</span>, pool_size=<span class="number">20</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_in_process</span><span class="params">(self, x, y=<span class="string">'hehe'</span>)</span>:</span></div><div class="line">        print(<span class="string">'run in process'</span>)</div><div class="line">        self.engine.dispose()</div><div class="line">        conn = self.engine.connect()</div><div class="line">        res = conn.execute(<span class="string">'select count(1) from zhihu.zhihu_answer_meta limit 10'</span>)</div><div class="line">        print(res.fetchall())</div><div class="line">        time.sleep(<span class="number">5</span>)</div><div class="line">        print(conn)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        x = <span class="string">'x'</span> </div><div class="line">        res_list = []</div><div class="line">        res = self.pool.apply_async(self.run_in_process, args=(x,), kwds=&#123;<span class="string">'y'</span>:<span class="string">'shit'</span>&#125;)</div><div class="line">        res_list.append(res)</div><div class="line">        <span class="comment">#[each.get(3) for each in res_list]</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_pool</span><span class="params">(self)</span>:</span></div><div class="line">        self.pool.close()</div><div class="line">        self.pool.join()</div><div class="line"></div><div class="line">client = Client()</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</div><div class="line">    client.run()</div><div class="line"></div><div class="line">client.run_pool()</div></pre></td></tr></table></figure></p>
<p>这段代码我的目的是想用多个进程多个connector连接到MySQL，然后各自进程同时去查询，这样便可以实现并行处理，<br>提升效率。然而，实际上这段代码不能正常地执行，而且没有任何报错提示。这是为何呢？</p>
<p>有些时候可能会看到这样的报错:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">TypeError: can&apos;t pickle _thread._local objects</div></pre></td></tr></table></figure></p>
<p><a href="https://stackoverflow.com/questions/58022926/cant-pickle-the-sqlalchemy-engine-in-the-class" target="_blank" rel="external">https://stackoverflow.com/questions/58022926/cant-pickle-the-sqlalchemy-engine-in-the-class</a></p>
<p>下面我把上面的代码修改下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</div><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">import</span> pymysql</div><div class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Client</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.pool = Pool(<span class="number">5</span>)</div><div class="line">        self.connection = pymysql.connect(host=<span class="string">'localhost'</span>,</div><div class="line">                             user=<span class="string">'root'</span>,</div><div class="line">                             password=<span class="string">'ignorance'</span>,</div><div class="line">                             port=<span class="number">3306</span>,</div><div class="line">                             charset=<span class="string">'utf8mb4'</span>,</div><div class="line">                             cursorclass=pymysql.cursors.DictCursor)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_in_process</span><span class="params">(self, x, y=<span class="string">'hehe'</span>)</span>:</span></div><div class="line">        <span class="comment"># 这里我们把engine改为了方法的内部变量，而不是实例变量。这样就不报错了</span></div><div class="line">        engine = create_engine(f<span class="string">'mysql+pymysql://root:ignorance@localhost:3306/'</span>, server_side_cursors=<span class="keyword">True</span>, pool_size=<span class="number">20</span>)</div><div class="line">        engine.dispose()</div><div class="line">        conn = engine.connect()</div><div class="line">        res = conn.execute(<span class="string">'select count(1) from zhihu.zhihu_answer_meta limit 10'</span>)</div><div class="line">        print(res.fetchall())</div><div class="line">        time.sleep(<span class="number">5</span>)</div><div class="line">        print(conn)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        x = <span class="string">'x'</span></div><div class="line">        res_list = []</div><div class="line">        res = self.pool.apply_async(self.run_in_process, args=(x,), kwds=&#123;<span class="string">'y'</span>:<span class="string">'shit'</span>&#125;)</div><div class="line">        res_list.append(res)</div><div class="line">        <span class="comment">#[each.get(3) for each in res_list]</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_pool</span><span class="params">(self)</span>:</span></div><div class="line">        self.pool.close()</div><div class="line">        self.pool.join()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getstate__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment"># 这里我增加了这个魔术方法</span></div><div class="line">        self_dict = self.__dict__.copy()</div><div class="line">        <span class="keyword">del</span> self_dict[<span class="string">'pool'</span>]</div><div class="line">        <span class="keyword">del</span> self_dict[<span class="string">'connection'</span>]  <span class="comment"># if conenction is not deleted, it would be silent without any errors</span></div><div class="line">        <span class="keyword">return</span> self_dict</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setstate__</span><span class="params">(self, state)</span>:</span></div><div class="line">        <span class="comment"># 这里我增加了这个魔术方法</span></div><div class="line">        self.__dict__.update(state)</div><div class="line"></div><div class="line"></div><div class="line">client = Client()</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</div><div class="line">    client.run()</div><div class="line"></div><div class="line">client.run_pool()</div></pre></td></tr></table></figure></p>
<h4 id="我们看到，这段代码有一些变化："><a href="#我们看到，这段代码有一些变化：" class="headerlink" title="我们看到，这段代码有一些变化："></a>我们看到，这段代码有一些变化：</h4><blockquote>
<p>增加了<strong>getstate</strong>， <strong>getstate</strong>这两个魔术方法。为什么要加呢？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">首先，我们 self.pool.apply_async(self.run_in_process) 可以看出apply_async调用的是实例的方法，所以Python需要pickle整个Client对象，</div><div class="line">包括它的所有实例变量。在第一个代码片段中我们可以看到它的实例变量有pool, connection, engine等等。然而这些对象都是不可以被pickle的，</div><div class="line">所以代码执行的时候会有问题。所以就有了__getstate__， __getstate__ 这两个东西。</div></pre></td></tr></table></figure></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">__getstate__ 总是在对象pickle之前调用， 同时，它让你可以指定你想pickle的对象状态。然后unpickle的时候，</div><div class="line">如果__setstate__被实现了，则__setstate__(state)会被调用。如果没有被实现的话，__getstate__返回的dict将会被</div><div class="line">unpickle的实例使用。在上面例子中，__setstate__ 其实没有实际效果，不写也可以。</div></pre></td></tr></table></figure>
<h3 id="multiprocessing的一些细节"><a href="#multiprocessing的一些细节" class="headerlink" title="multiprocessing的一些细节"></a>multiprocessing的一些细节</h3><h4 id="传多个参数在target函数"><a href="#传多个参数在target函数" class="headerlink" title="传多个参数在target函数"></a>传多个参数在target函数</h4><p>有时候当我们想在apply_async 的 target函数上传指定参数的时候, 可以用kwds传进去,比如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_in_process</span><span class="params">(self, x, y=<span class="string">'hehe'</span>)</span>:</span></div><div class="line">    <span class="comment"># 这里我们把engine改为了方法的内部变量，而不是实例变量。</span></div><div class="line">    print(x)</div><div class="line">    print(y)</div><div class="line">    </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">    x = <span class="string">'x'</span></div><div class="line">    res = self.pool.apply_async(self.run_in_process, args=(x,), kwds=&#123;<span class="string">'y'</span>:<span class="string">'shit'</span>&#125;)</div></pre></td></tr></table></figure></p>
<h4 id="map和apply的区别"><a href="#map和apply的区别" class="headerlink" title="map和apply的区别"></a>map和apply的区别</h4><p>map执行的顺序是和参数的顺序一致的，apply_async的顺序是随机的<br>map一般用来切分参数执行在同一个方法上。而apply_async可以调用不同的方法。</p>
<p>此外,<br>map相当于 map_async().get()<br>apply相当于 apply_async().get()</p>
<h5 id="子进程报错没有提示"><a href="#子进程报错没有提示" class="headerlink" title="子进程报错没有提示"></a>子进程报错没有提示</h5><p>有个很坑的地方，有些时候逻辑明明没有执行，但又没有任何报错！<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span><span class="params">()</span>:</span></div><div class="line">    <span class="comment">#@staticmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">work</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"error"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    pool = mp.Pool()</div><div class="line">    foo = Foo()</div><div class="line">    res = pool.apply_async(foo.work)</div><div class="line">    pool.close()</div><div class="line">    pool.join()</div><div class="line">    <span class="comment">#print(res.get())</span></div></pre></td></tr></table></figure></p>
<p> 比如这个，如果我不get() 一下 apply_async后的返回的话，看不到任何报错信息，解决办法就是用get()后才<br> 能得知报错的信息。</p>
<h4 id="加装饰器后报错"><a href="#加装饰器后报错" class="headerlink" title="加装饰器后报错"></a>加装饰器后报错</h4><p> 比如我们在<code>run_in_process</code>方法上了个装饰器，然后就报错了。<br> <figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">timeit</span><span class="params">(method)</span>:</span></div><div class="line">   <span class="function"><span class="keyword">def</span> <span class="title">timed</span><span class="params">(*args, **kw)</span>:</span></div><div class="line">       ts = time.time()</div><div class="line">       result = method(*args, **kw)</div><div class="line">       te = time.time()</div><div class="line">       <span class="keyword">if</span> <span class="string">'log_time'</span> <span class="keyword">in</span> kw: </div><div class="line">           name = kw.get(<span class="string">'log_name'</span>, method.__name__.upper())</div><div class="line">           kw[<span class="string">'log_time'</span>][name] = int((te - ts) * <span class="number">1000</span>)</div><div class="line">       <span class="keyword">else</span>:</div><div class="line">           print(<span class="string">'%r 执行时长  %2.2f s'</span> % (method.__name__, (te - ts) ))</div><div class="line">       <span class="keyword">return</span> result</div><div class="line">   <span class="keyword">return</span> timed</div><div class="line">   </div><div class="line"><span class="meta">   @timeit</span></div><div class="line">   <span class="function"><span class="keyword">def</span> <span class="title">run_in_process</span><span class="params">(self, x, y=<span class="string">'hehe'</span>)</span>:</span></div><div class="line">       <span class="comment"># 这里我们把engine改为了方法的内部变量，而不是实例变量。</span></div><div class="line">       print(x)</div><div class="line">       print(y)</div><div class="line">       </div><div class="line">   <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">       x = <span class="string">'x'</span></div><div class="line">       res = self.pool.apply_async(self.run_in_process, args=(x,), kwds=&#123;<span class="string">'y'</span>:<span class="string">'shit'</span>&#125;)</div></pre></td></tr></table></figure></p>
<p>报错说:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Traceback (most recent call last):</div><div class="line">  File &quot;/data/software/miniconda3/lib/python3.7/multiprocessing/process.py&quot;, line 297, in _bootstrap</div><div class="line">    self.run()</div><div class="line">  File &quot;/data/software/miniconda3/lib/python3.7/multiprocessing/process.py&quot;, line 99, in run</div><div class="line">    self._target(*self._args, **self._kwargs)</div><div class="line">  File &quot;/data/software/miniconda3/lib/python3.7/multiprocessing/pool.py&quot;, line 110, in worker</div><div class="line">    task = get()</div><div class="line">  File &quot;/data/software/miniconda3/lib/python3.7/multiprocessing/queues.py&quot;, line 354, in get</div><div class="line">    return _ForkingPickler.loads(res)</div><div class="line">AttributeError: &apos;Client&apos; object has no attribute &apos;timed&apos;</div></pre></td></tr></table></figure></p>
<p>解决办法：<br>比较麻烦，不能用@了。可以以这种办法代替装饰器：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">decorate_func</span><span class="params">(f)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_decorate_func</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">print</span> <span class="string">"I'm decorating"</span></div><div class="line">        <span class="keyword">return</span> f(*args, **kwargs)</div><div class="line">    <span class="keyword">return</span> _decorate_func</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">actual_func</span><span class="params">(x)</span>:</span></div><div class="line">    <span class="keyword">return</span> x ** <span class="number">2</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrapped_func</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">    <span class="keyword">return</span> decorate_func(actual_func)(*args, **kwargs)</div><div class="line"></div><div class="line">my_swimming_pool = Pool()</div><div class="line">result = my_swimming_pool.apply_async(wrapped_func,(<span class="number">2</span>,))</div><div class="line"><span class="keyword">print</span> result.get()</div></pre></td></tr></table></figure></p>
<h4 id="关于处理ctrl-c-的报错"><a href="#关于处理ctrl-c-的报错" class="headerlink" title="关于处理ctrl-c 的报错:"></a>关于处理ctrl-c 的报错:</h4><p>有时候我们用multiprocessing处理一些任务，当我们想终止任务时候，用Ctrl+C 然后会看到一堆的报错，有时候还得连续按很多CTRL+C完全终止掉。<br>下面是最佳解决方案：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">解决办法是 首先防止子进程接收KeyboardInterrupt，然后完全交给父进程catch interrupt然后清洗进程池。通过这种方法可以</div><div class="line">避免在子进程写处理异常逻辑，并且防止了由idle workers 生成的无止尽的Error。</div></pre></td></tr></table></figure></p>
<p>解决方案代码:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> multiprocessing</div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> signal</div><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_worker</span><span class="params">()</span>:</span></div><div class="line">    signal.signal(signal.SIGINT, signal.SIG_IGN)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_worker</span><span class="params">()</span>:</span></div><div class="line">    time.sleep(<span class="number">15</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"Initializng 5 workers"</span></div><div class="line">    pool = multiprocessing.Pool(<span class="number">5</span>, init_worker)</div><div class="line"></div><div class="line">    <span class="keyword">print</span> <span class="string">"Starting 3 jobs of 15 seconds each"</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</div><div class="line">        pool.apply_async(run_worker)</div><div class="line"></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        print(<span class="string">"Waiting 10 seconds"</span>)</div><div class="line">        time.sleep(<span class="number">10</span>)</div><div class="line"></div><div class="line">    <span class="keyword">except</span> KeyboardInterrupt:</div><div class="line">        print(<span class="string">"Caught KeyboardInterrupt, terminating workers"</span>)</div><div class="line">        pool.terminate()</div><div class="line">        pool.join()</div><div class="line"></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">"Quitting normally"</span></div><div class="line">        pool.close()</div><div class="line">        pool.join()</div></pre></td></tr></table></figure></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://docs.python.org/3/library/pickle.html" target="_blank" rel="external">https://docs.python.org/3/library/pickle.html</a><br><a href="https://stackoverflow.com/questions/25382455/python-notimplementederror-pool-objects-cannot-be-passed-between-processes/25385582#25385582" target="_blank" rel="external">https://stackoverflow.com/questions/25382455/python-notimplementederror-pool-objects-cannot-be-passed-between-processes/25385582#25385582</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mikolaje.github.io/2019/hive_orc.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dennis">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Welcome to Dennis Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/hive_orc.html" itemprop="url">Hive 使用orc进行事务操作(update)</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-22T11:01:10+08:00">
                2019-06-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/hive/" itemprop="url" rel="index">
                    <span itemprop="name">hive</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/hive_orc.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/hive_orc.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="需求背景"><a href="#需求背景" class="headerlink" title="需求背景"></a>需求背景</h2><p>需求方需要用Hive来进行一些update操作。以往一般用Parquet这种格式作为Hive的存储格式，查文档得知Parquet不支持<br>update，orc格式可以支持update。</p>
<h2 id="开始试验"><a href="#开始试验" class="headerlink" title="开始试验"></a>开始试验</h2><h3 id="创建测试数据"><a href="#创建测试数据" class="headerlink" title="创建测试数据"></a>创建测试数据</h3><p>首先我们在Hive上简单地创建一个表作为测试：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">create table test_format (</div><div class="line">    car_name string,</div><div class="line">    series string,</div><div class="line">    e_series string,</div><div class="line">    model string,</div><div class="line">    variant string</div><div class="line">) clustered by (car_name) into 5 buckets stored as orc TBLPROPERTIES(&apos;transactional&apos;=&apos;true&apos;);</div><div class="line"></div><div class="line">insert into test_format values</div><div class="line">(&apos;2017款宝马3系320i M运动型&apos;,&apos;3&apos;,&apos;F30&apos;,&apos;320i&apos;,&apos;320i M Sport Package&apos;),</div><div class="line">(&apos;2018款宝马3系320i M运动套装&apos;,&apos;3&apos;,&apos;F30&apos;,&apos;320i&apos;,&apos;320i M Sport Package&apos;),</div><div class="line">(&apos;2018款宝马3系320i M运动曜夜版&apos;,&apos;3&apos;,&apos;F30&apos;,&apos;320i&apos;,&apos;320i M Sport Dark Edition&apos;),</div><div class="line">(&apos;2019款宝马3系320i M 运动套装&apos;,&apos;3&apos;,&apos;F30&apos;,&apos;320i&apos;,&apos;320i M Sport Package&apos;);</div></pre></td></tr></table></figure></p>
<p>刚开始会有报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">This command is not allowed on an ACID table auto_projects.test_format with a non-ACID transaction manager. Failed command: insert into test_format value</div></pre></td></tr></table></figure></p>
<p>这是因为有些配置文件需要修改才能支持transaction操作。</p>
<p>在hive-site.xml里面添加如下配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">&lt;property&gt;</div><div class="line">    &lt;name&gt;hive.optimize.sort.dynamic.partition&lt;/name&gt;</div><div class="line">    &lt;value&gt;false&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line">&lt;property&gt;</div><div class="line">    &lt;name&gt;hive.support.concurrency&lt;/name&gt;</div><div class="line">    &lt;value&gt;true&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line">&lt;property&gt;</div><div class="line">    &lt;name&gt;hive.enforce.bucketing&lt;/name&gt;</div><div class="line">    &lt;value&gt;true&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line">&lt;property&gt;</div><div class="line">    &lt;name&gt;hive.exec.dynamic.partition.mode&lt;/name&gt;</div><div class="line">    &lt;value&gt;nonstrict&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line">&lt;property&gt;</div><div class="line">    &lt;name&gt;hive.txn.manager&lt;/name&gt;</div><div class="line">    &lt;value&gt;org.apache.hadoop.hive.ql.lockmgr.DbTxnManager&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line">&lt;property&gt;</div><div class="line">    &lt;name&gt;hive.compactor.initiator.on&lt;/name&gt;</div><div class="line">    &lt;value&gt;true&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line">&lt;property&gt;</div><div class="line">    &lt;name&gt;hive.compactor.worker.threads&lt;/name&gt;</div><div class="line">    &lt;value&gt;1&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line">&lt;property&gt;</div><div class="line">    &lt;name&gt;hive.in.test&lt;/name&gt;</div><div class="line">    &lt;value&gt;true&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div></pre></td></tr></table></figure></p>
<p>Cloudera Manager的话则可以在WebUI上完成。</p>
<ol>
<li>在WebUI上先点击Hive集群。</li>
<li>点击配置，然后找到一个叫hive-site.xml 的 HiveServer2 高级配置代码段（安全阀）的tag中</li>
<li>将上述配置内容复制在文本框内。</li>
<li>重启集群</li>
</ol>
<h3 id="测试更新数据"><a href="#测试更新数据" class="headerlink" title="测试更新数据"></a>测试更新数据</h3><p>测试更新和删除部分数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">update test_format set model=&apos;test&apos; where series=&apos;3&apos;;</div><div class="line"></div><div class="line">delete  from test_format where model=&apos;test&apos;;</div></pre></td></tr></table></figure></p>
<p>这里需要注意的一个地方就是 要更新的字段不能是设置为bucket的那个字段，不然会报错：</p>
<p>成功执行！</p>
<h3 id="踩的一些坑"><a href="#踩的一些坑" class="headerlink" title="踩的一些坑"></a>踩的一些坑</h3><p>因为我是用的单节点部署的CDH集群。刚开始，在Hive上执行select count(*) ; 和 insert操作时候，没有任何报错，<br>但会一直卡在那里。后来查看到cloudera community说单节点要改个mapred-site.xml的一个参数：<br>mapreduce.framework.name</p>
<p>默认是用的yarn，单机的话要改为local，然后重启集群insert 和 select count(*) 就不会卡住了,<br>CDH也是在WebUI上的Yarn集群上的配置上修改。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://www.cnblogs.com/qifengle-2446/p/6424620.html" target="_blank" rel="external">https://www.cnblogs.com/qifengle-2446/p/6424620.html</a><br><a href="https://community.cloudera.com/t5/Batch-SQL-Apache-Hive/Hive-server-query-hanging-when-issue-ing-select-count-on-CLI/m-p/67119#M2662" target="_blank" rel="external">https://community.cloudera.com/t5/Batch-SQL-Apache-Hive/Hive-server-query-hanging-when-issue-ing-select-count-on-CLI/m-p/67119#M2662</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mikolaje.github.io/2019/typical_bigdata_interview_question.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dennis">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Welcome to Dennis Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/typical_bigdata_interview_question.html" itemprop="url">经典的大数据面试题</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-02T12:07:10+08:00">
                2019-06-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/interview/" itemprop="url" rel="index">
                    <span itemprop="name">interview</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/typical_bigdata_interview_question.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/typical_bigdata_interview_question.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近面试大数据工程师岗位，同一个问题被连续问了两次。题目大概是这样的：<br>如果你有一台机器，内存是有限的，要你统计一个很大的日志文件里的数据，比如统计UV top-N；<br>另外一个公司是这么问：<br>如果你有一台机器，内存有限，要你对某个指标做一个全局排序。比如对单词频次进行全局排序。</p>
<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>第一种问题是比较简单的。这种问题一般都问在某个条件下如何在大数据中求出top-N。这种问题的解决方案如下步骤：</p>
<ol>
<li>分而治之/hash映射。</li>
<li>hash统计。</li>
<li>堆/快速/归并排序；</li>
</ol>
<p>首先，为什么药hash映射呢？<br>因为，我们的目的要将一个大文件切割成N个小文件，去进行分而治之。而hash 加 取模 这种方式可以帮我们把数据<br>均匀随机地分布在N个地方。更重要的是，hash可以让我们把相同的东西放在同一个地方！</p>
<p>其实这种做法在有些地方出现过，比如Hive的bucket实现原理就是这个中道理。用hash加取模的方式保证同样的值被<br>分配到同一个地方。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://blog.csdn.net/v_july_v/article/details/7382693" target="_blank" rel="external">https://blog.csdn.net/v_july_v/article/details/7382693</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mikolaje.github.io/2019/hive_bucket_partition.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dennis">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Welcome to Dennis Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/hive_bucket_partition.html" itemprop="url">Hive bucket和partition的区别</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-02T11:01:10+08:00">
                2019-06-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/hive/" itemprop="url" rel="index">
                    <span itemprop="name">hive</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/hive_bucket_partition.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/hive_bucket_partition.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Hive-partition和bucket的区别"><a href="#Hive-partition和bucket的区别" class="headerlink" title="Hive partition和bucket的区别"></a>Hive partition和bucket的区别</h2><ul>
<li>翻译文</li>
</ul>
<p>为了更好地阐述partition和bucket的区别，我们先看看数据是怎么保存在Hive上面的。比如，你有一个表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">CREATE TABLE mytable ( </div><div class="line">         name string,</div><div class="line">         city string,</div><div class="line">         employee_id int ) </div><div class="line">PARTITIONED BY (year STRING, month STRING, day STRING) </div><div class="line">CLUSTERED BY (employee_id) INTO 256 BUCKETS</div></pre></td></tr></table></figure></p>
<p>然后，Hive会将数据保存为如下的层级：<br>/user/hive/warehouse/mytable/y=2015/m=12/d=02<br>所以，用partition的时候必须小心，因为如果你用employee_id来partition的话，如果有上百万个employee，那么你会看到有上百万个目录被创建在你的系统上。<br>“cardinality” 这个术语被用来表示不同字段值的数量。比如，你有country这个字段，世界上会有300个国家，所以这里的”cardinality”是300这样。<br>对于像’timestamp_ms’的字段，它的’cardinality’会有几十亿。<br>总的来说，当我们用partition的时候，不要用在cardinality很高的字段上。因为它会导致生成太多的目录。</p>
<p>说说bucket了，在指定了bucket数后，会使得文件的数量固定。Hive会做的是计算字段的hash值，然后分发一个记录给那个bucket。<br>但是比如说你用总共256个bucket在一个较低的cardinality的字段上会发生什么呢？（比如，美国的州，只有50个）<br>只有50个bucket有数据，其它206个bucket是没有数据的。</p>
<p>有人已经提到partition可以极大地减少查询数据的量。<br>那在我这个例子中，如果你想在某个日期上进一步查询，对 yearn/month/day的partition会大大地减少IO。<br>我觉得有人已经提到bucket可以加速和其它恰好在同一个bucket的表的join操作。那么在我的案例中，如果你正在通过employee_id来join两个表，<br>Hive能够在每个每个bucket地内部进行join（如果它们已经通过employee_id排序好的话，效果会更好！）</p>
<p>总结，<br>bucket在字段有很高的cardinality，和在数据在不同bucket中均匀地分布的时候，会表现出优越性。<br>partition在cardinality partition的字段不是很多的时候，会表现出优越性。</p>
<p>另外，你可以按顺序同时partiton多个字段，比如（yearn/month/day），但bucket只能取一个字段。</p>
<ul>
<li>原文<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">There are a few details missing from the previous explanations. To better understand how partitioning and bucketing works,</div><div class="line"> you should look at how data is stored in hive. Let&apos;s say you have a table</div><div class="line"></div><div class="line">CREATE TABLE mytable ( </div><div class="line">         name string,</div><div class="line">         city string,</div><div class="line">         employee_id int ) </div><div class="line">PARTITIONED BY (year STRING, month STRING, day STRING) </div><div class="line">CLUSTERED BY (employee_id) INTO 256 BUCKETS</div><div class="line">then hive will store data in a directory hierarchy like</div><div class="line"></div><div class="line">/user/hive/warehouse/mytable/y=2015/m=12/d=02</div><div class="line">So, you have to be careful when partitioning, because if you for instance partition by employee_id and you have millions of employees, </div><div class="line">you&apos;ll end up having millions of directories in your file system. The term &apos;cardinality&apos; refers to the number of possible value a field can have. </div><div class="line">For instance, if you have a &apos;country&apos; field, the countries in the world are about 300, so cardinality would be ~300. </div><div class="line">For a field like &apos;timestamp_ms&apos;, which changes every millisecond, cardinality can be billions. </div><div class="line">In general, when choosing a field for partitioning, it should not have a high cardinality, because you&apos;ll end up with way too many directories in your file system.</div><div class="line"></div><div class="line">Clustering aka bucketing on the other hand, will result with a fixed number of files, since you do specify the number of buckets. </div><div class="line">What hive will do is to take the field, calculate a hash and assign a record to that bucket. </div><div class="line">But what happens if you use let&apos;s say 256 buckets and the field you&apos;re bucketing on has a low cardinality (for instance, it&apos;s a US state, so can be only 50 different values) ? </div><div class="line">You&apos;ll have 50 buckets with data, </div><div class="line">and 206 buckets with no data.</div><div class="line"></div><div class="line">Someone already mentioned how partitions can dramatically cut the amount of data you&apos;re querying. </div><div class="line">So in my example table, if you want to query only from a certain date forward, the partitioning by year/month/day is going to dramatically cut the amount of IO. </div><div class="line">I think that somebody also mentioned how bucketing can speed up joins with other tables that have exactly the same bucketing, </div><div class="line">so in my example, if you&apos;re joining two tables on the same employee_id, </div><div class="line">hive can do the join bucket by bucket (even better if they&apos;re already sorted by employee_id since it&apos;s going to mergesort parts that are already sorted, </div><div class="line">which works in linear time aka O(n) ).</div><div class="line"></div><div class="line">So, bucketing works well when the field has high cardinality and data is evenly distributed among buckets. </div><div class="line">Partitioning works best when the cardinality of the partitioning field is not too high.</div><div class="line"></div><div class="line">Also, you can partition on multiple fields, with an order (year/month/day is a good example), while you can bucket on only one field.</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://stackoverflow.com/questions/19128940/what-is-the-difference-between-partitioning-and-bucketing-a-table-in-hive" target="_blank" rel="external">https://stackoverflow.com/questions/19128940/what-is-the-difference-between-partitioning-and-bucketing-a-table-in-hive</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mikolaje.github.io/2019/spark_when_to_cache.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dennis">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Welcome to Dennis Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/spark_when_to_cache.html" itemprop="url">Spark什么时候用 persist</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-02T12:07:10+08:00">
                2019-05-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/spark/" itemprop="url" rel="index">
                    <span itemprop="name">spark</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/spark_when_to_cache.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/spark_when_to_cache.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近在用Spark做一些数据统计，有个任务要跑几个小时，所以需要优化一下。首先想到的是用 persist或者cache(persist的其中一种方式)</p>
<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><h3 id="场景一"><a href="#场景一" class="headerlink" title="场景一"></a>场景一</h3><h4 id="首先看看在Stackoverflow的一个回答"><a href="#首先看看在Stackoverflow的一个回答" class="headerlink" title="首先看看在Stackoverflow的一个回答"></a>首先看看在Stackoverflow的一个回答</h4><p>Spark很多惰性算子，它并不会立即执行，persist就是惰性的。只有当被action trigger的时候，叫 lineage的RDD 链才会被执行。<br>如果是线性的lineage的话，persist是没用的。但如果RDD的lineage被分流出去的话，那么persist就有用了。</p>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># 比如这种情况，有个两个action算子count；</div><div class="line">val positiveWordsCount = wordsRDD.filter(word =&gt; isPositive(word)).count()</div><div class="line">val negativeWordsCount = wordsRDD.filter(word =&gt; isNegative(word)).count()</div><div class="line"></div><div class="line"></div><div class="line"># 可以在公用的RDD上加个cache，让这个flatMap只计算一次</div><div class="line">val textFile = sc.textFile(&quot;/user/emp.txt&quot;)</div><div class="line">val wordsRDD = textFile.flatMap(line =&gt; line.split(&quot;\\W&quot;))</div><div class="line">wordsRDD.cache()</div><div class="line">val positiveWordsCount = wordsRDD.filter(word =&gt; isPositive(word)).count()</div><div class="line">val negativeWordsCount = wordsRDD.filter(word =&gt; isNegative(word)).count()</div></pre></td></tr></table></figure>
<p>另外一个案例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_url</span><span class="params">(value)</span>:</span></div><div class="line">    url = <span class="string">'http://domain.com/'</span> + str(value)</div><div class="line">    <span class="keyword">if</span> value == <span class="string">'1134021255504498689'</span>:</div><div class="line">        print(value)  <span class="comment"># 这里print出来可以作为一个标记，知道 这个udf执行了几次</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> url </div><div class="line">    </div><div class="line">url_udf = udf(make_url, StringType())</div><div class="line">df = spark.read.csv(<span class="string">'file:///Users/xiaofeilong/Documents/twitter_tweet_keyword.csv'</span>)</div><div class="line"></div><div class="line">df = df.withColumn(<span class="string">'url'</span>, url_udf(<span class="string">'_c0'</span>))</div><div class="line"><span class="comment"># df.cache() </span></div><div class="line">df1 = df.filter(df._c1.isin([<span class="string">'petcare'</span>]))</div><div class="line">df2 = df.filter(df._c1.isin([<span class="string">'hound'</span>]))</div><div class="line"></div><div class="line">df_union = df1.union(df2)</div><div class="line">df_union = df_union.orderBy(<span class="string">'url'</span>)  <span class="comment"># 这里加order by url的原因是，要让它执行url_udf。不然如果这个字段没用上的话，Spark并不会执行url_udf</span></div><div class="line">print(df_union.count())</div></pre></td></tr></table></figure></p>
<p>上述例子中，如果不加cache的话。log中可以看到打印了两次 1134021255504498689。而且会看到有两条这样的信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">INFO FileScanRDD: Reading File path: file:///Users/xiaofeilong/Documents/twitter_tweet_keyword.csv, range: 0-2315578, partition values: [empty row]</div><div class="line">.</div><div class="line">.</div><div class="line">.</div><div class="line">FileScanRDD: Reading File path: file:///Users/xiaofeilong/Documents/twitter_tweet_keyword.csv, range: 0-2315578, partition values: [empty row]</div></pre></td></tr></table></figure></p>
<h4 id="测试结论！"><a href="#测试结论！" class="headerlink" title="测试结论！"></a>测试结论！</h4><ul>
<li><p>说明csv文件被load了两次！！！</p>
</li>
<li><p>如果用了cache的话，只会出现一次！！！</p>
</li>
</ul>
<h3 id="场景二"><a href="#场景二" class="headerlink" title="场景二"></a>场景二</h3><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://stackoverflow.com/questions/28981359/why-do-we-need-to-call-cache-or-persist-on-a-rdd" target="_blank" rel="external">https://stackoverflow.com/questions/28981359/why-do-we-need-to-call-cache-or-persist-on-a-rdd</a><br><a href="https://blog.csdn.net/ainidong2005/article/details/53152605" target="_blank" rel="external">https://blog.csdn.net/ainidong2005/article/details/53152605</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mikolaje.github.io/2019/git_filter_branch.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dennis">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Welcome to Dennis Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/git_filter_branch.html" itemprop="url">Git删除误add的文件</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-02T11:07:10+08:00">
                2019-05-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/git/" itemprop="url" rel="index">
                    <span itemprop="name">git</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/git_filter_branch.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/git_filter_branch.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><h4 id="很多时候，我们经常会不小心把一个不应该add进来的文件-add到-Repo里了。比如："><a href="#很多时候，我们经常会不小心把一个不应该add进来的文件-add到-Repo里了。比如：" class="headerlink" title="很多时候，我们经常会不小心把一个不应该add进来的文件 add到 Repo里了。比如："></a>很多时候，我们经常会不小心把一个不应该add进来的文件 add到 Repo里了。比如：</h4><p>password.txt，<em>.log  </em>.mp4 等等。</p>
<h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><h4 id="这种情况下，我们可以选择用-git-filter-branch-来将历史的所有commit都重新过滤一下。"><a href="#这种情况下，我们可以选择用-git-filter-branch-来将历史的所有commit都重新过滤一下。" class="headerlink" title="这种情况下，我们可以选择用 git filter-branch 来将历史的所有commit都重新过滤一下。"></a>这种情况下，我们可以选择用 git filter-branch 来将历史的所有commit都重新过滤一下。</h4><h4 id="查看Git的文档得知，filter-branch是一个核弹级操作"><a href="#查看Git的文档得知，filter-branch是一个核弹级操作" class="headerlink" title="查看Git的文档得知，filter-branch是一个核弹级操作:"></a>查看Git的文档得知，filter-branch是一个核弹级操作:</h4><blockquote>
<p>如果你想用脚本的方式修改大量的提交，还有一个重写历史的选项可以用——例如，全局性地修改电子邮件地址或者将一个文件从所有提交中删除。<br>这个命令是filter-branch，这个会大面积地修改你的历史，所以你很有可能不该去用它，除非你的项目尚未公开，没有其他人在你准备修改的提交的基础上工作。<br>尽管如此，这个可以非常有用。你会学习一些常见用法，借此对它的能力有所认识。<br><br>从所有提交中删除一个文件<br>这个经常发生。有些人不经思考使用git add .，意外地提交了一个巨大的二进制文件，你想将它从所有地方删除。<br>也许你不小心提交了一个包含密码的文件，而你想让你的项目开源。filter-branch大概会是你用来清理整个历史的工具。<br>要从整个历史中删除一个名叫password.txt的文件，你可以在filter-branch上使用–tree-filter选项</p>
</blockquote>
<h4 id="Example：把历史中不小心添加进来的所有mp4文件清除。"><a href="#Example：把历史中不小心添加进来的所有mp4文件清除。" class="headerlink" title="Example：把历史中不小心添加进来的所有mp4文件清除。"></a>Example：把历史中不小心添加进来的所有mp4文件清除。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">删除所有后缀为mp4 的历史提交文件</div><div class="line"></div><div class="line">git filter-branch --index-filter &apos;git rm -r --cached --ignore-unmatch *.mp4&apos; --prune-empty -f</div><div class="line">git for-each-ref --format=&apos;delete %(refname)&apos; refs/original | git update-ref --stdin </div><div class="line">git reflog expire --expire=now --all &amp;&amp; git gc --aggressive --prune=now </div><div class="line"></div><div class="line">如果要push到remote Repo的话，需要加-f 强推</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="Dennis" />
            
              <p class="site-author-name" itemprop="name">Dennis</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">36</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/mikolaje" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/mikolaj" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-zhihu"></i>知乎</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://stackoverflow.com/users/6169688/dennisli" target="_blank" title="StackOverflow">
                      
                        <i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Dennis</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://mikolaje.disqus.com/count.js" async></script>
    

    

  




	





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.4"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.4"></script>


  

</body>
</html>
