<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">
<meta name="google-site-verification" content="FBOEHstXs_V88mUuDszTtuMR2PSgYzHaLqSzjMwzCcE" />









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="hive," />










<meta name="description" content="对于如果join中有小表的话，可以开启map
Dynamic Partition Pruning for Hive Map JoinsYou can enable dynamic partition pruning for map joins when you are running Hive on Spark (HoS), it is not available for Hive on MapR">
<meta property="og:type" content="article">
<meta property="og:title" content="Hive 优化">
<meta property="og:url" content="http://mikolaje.github.io/2018/hive_optimization.html">
<meta property="og:site_name" content="Welcome to Dennis Blog">
<meta property="og:description" content="对于如果join中有小表的话，可以开启map
Dynamic Partition Pruning for Hive Map JoinsYou can enable dynamic partition pruning for map joins when you are running Hive on Spark (HoS), it is not available for Hive on MapR">
<meta property="og:updated_time" content="2019-10-26T02:01:43.844Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hive 优化">
<meta name="twitter:description" content="对于如果join中有小表的话，可以开启map
Dynamic Partition Pruning for Hive Map JoinsYou can enable dynamic partition pruning for map joins when you are running Hive on Spark (HoS), it is not available for Hive on MapR">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://mikolaje.github.io/2018/hive_optimization.html"/>





  <title>Hive 优化 | Welcome to Dennis Blog</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-146421461-1', 'auto');
  ga('send', 'pageview');
</script>





 
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  

    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Welcome to Dennis Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- side -->
<ins class="adsbygoogle"
     style="display:inline-block;width:728px;height:90px"
     data-ad-client="ca-pub-9293695697921628"
     data-ad-slot="4837815018"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://mikolaje.github.io/2018/hive_optimization.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dennis">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Welcome to Dennis Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Hive 优化</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-02T12:07:10+08:00">
                2018-06-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/hive_optimization.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/hive_optimization.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>对于如果join中有小表的话，可以开启map</p>
<h3 id="Dynamic-Partition-Pruning-for-Hive-Map-Joins"><a href="#Dynamic-Partition-Pruning-for-Hive-Map-Joins" class="headerlink" title="Dynamic Partition Pruning for Hive Map Joins"></a>Dynamic Partition Pruning for Hive Map Joins</h3><p>You can enable dynamic partition pruning for map joins when you are running Hive on Spark (HoS), it is not available for Hive on MapReduce.<br>Dynamic partition pruning (DPP) is a database optimization that can significantly decrease the amount of data that a query scans, thereby executing your workloads faster.<br>DPP achieves this by dynamically determining and eliminating the number of partitions that a query must read from a partitioned table.</p>
<p>Map joins also optimize how Hive executes queries. They cause a small table to be scanned and loaded in memory as a hash table<br>so that a fast join can be performed entirely within a mapper without having to use another reduce step.<br>If you have queries that join small tables, map joins can make them execute much faster.<br>Map joins are enabled by default in CDH with the Enable MapJoin Optimization setting for HiveServer2 in Cloudera Manager.<br>Hive automatically uses map joins for join queries that involve a set of tables where:</p>
<ul>
<li>There is one large table and there is no limit on the size of that large table.</li>
<li>All other tables involved in the join must have an aggregate size under the value set for Hive Auto Convert Join Noconditional Size for HiveServer2, which is set to 20MB by default in Cloudera Manager.</li>
</ul>
<p>关于map-side join的配置:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">SET hive.auto.convert.join=true;</div><div class="line">SET hive.auto.convert.join.noconditionaltask.size=&lt;number_in_megabytes&gt;;</div></pre></td></tr></table></figure></p>
<h2 id="一次调优实战"><a href="#一次调优实战" class="headerlink" title="一次调优实战"></a>一次调优实战</h2><p>最近在ETL过程中发现有条SQL执行时间非常长，其实数据量很小的，但为什么这么长呢。我带着极度好奇，抱着死缠烂打的精神，怎么也要把<br>问题给解决掉。SQL是这样的:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">from</span> zhihu_answer </div><div class="line"><span class="keyword">where</span> ym <span class="keyword">in</span> (<span class="keyword">select</span> <span class="keyword">distinct</span>(ym) <span class="keyword">from</span> zhihu.zhihu_answer_increment);</div></pre></td></tr></table></figure></p>
<p>先说说这两个表数据量吧：<br>zhihu_answer数据量大概是一亿，zhihu_answer_increment 也就是几十万条。<br>首先，我用<code>explain extended</code>查看下执行计划:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div></pre></td><td class="code"><pre><div class="line">explain extended</div><div class="line">select count(1) from zhihu_answer </div><div class="line">where ym in (select distinct(ym) from zhihu.zhihu_answer_increment);</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">Explain	</div><div class="line">STAGE DEPENDENCIES:	</div><div class="line">  Stage-3 is a root stage	</div><div class="line">  Stage-5 depends on stages: Stage-3 , consists of Stage-6, Stage-1	</div><div class="line">  Stage-6 has a backup stage: Stage-1	</div><div class="line">  Stage-4 depends on stages: Stage-6	</div><div class="line">  Stage-2 depends on stages: Stage-1, Stage-4	</div><div class="line">  Stage-1	</div><div class="line">  Stage-0 depends on stages: Stage-2	</div><div class="line">	</div><div class="line">STAGE PLANS:	</div><div class="line">  Stage: Stage-3	</div><div class="line">    Map Reduce	</div><div class="line">      Map Operator Tree:	</div><div class="line">          TableScan	</div><div class="line">            alias: zhihu_answer_increment	</div><div class="line">            filterExpr: ym is not null (type: boolean)	</div><div class="line">            Statistics: Num rows: 347468 Data size: 73315748 Basic stats: COMPLETE Column stats: COMPLETE	</div><div class="line">            GatherStats: false	</div><div class="line">            Select Operator	</div><div class="line">              expressions: ym (type: string)	</div><div class="line">              outputColumnNames: ym	</div><div class="line">              Statistics: Num rows: 347468 Data size: 73315748 Basic stats: COMPLETE Column stats: COMPLETE	</div><div class="line">              Group By Operator	</div><div class="line">                keys: ym (type: string)	</div><div class="line">                mode: hash	</div><div class="line">                outputColumnNames: _col0	</div><div class="line">                Statistics: Num rows: 1 Data size: 184 Basic stats: COMPLETE Column stats: COMPLETE	</div><div class="line">                Reduce Output Operator	</div><div class="line">                  key expressions: _col0 (type: string)	</div><div class="line">                  null sort order: a	</div><div class="line">                  sort order: +	</div><div class="line">                  Map-reduce partition columns: _col0 (type: string)	</div><div class="line">                  Statistics: Num rows: 1 Data size: 184 Basic stats: COMPLETE Column stats: COMPLETE	</div><div class="line">                  tag: -1	</div><div class="line">                  auto parallelism: false	</div><div class="line">      Execution mode: vectorized	</div><div class="line">      Path -&gt; Alias:	</div><div class="line">        nullscan://null/zhihu.zhihu_answer_increment/part_ym=201902_ [sq_1:zhihu_answer_increment]	</div><div class="line">      Path -&gt; Partition:	</div><div class="line">        nullscan://null/zhihu.zhihu_answer_increment/part_ym=201902_ 	</div><div class="line">          Partition	</div><div class="line">            input format: org.apache.hadoop.hive.ql.io.OneNullRowInputFormat	</div><div class="line">            output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat	</div><div class="line">            partition values:	</div><div class="line">              ym 201902	</div><div class="line">            properties:	</div><div class="line">              COLUMN_STATS_ACCURATE &#123;&quot;BASIC_STATS&quot;:&quot;true&quot;&#125;	</div><div class="line">              bucket_count 256	</div><div class="line">              bucket_field_name answer_id	</div><div class="line">              columns admin_closed_comment,answer_content,answer_created,answer_id,answer_updated,author_headline,author_id,author_name,author_type,author_url_token,avatar_url,badge_num,can_comment,comment_count,gender,insert_time,is_advertiser,is_collapsed,is_copyable,is_org,question_created,question_id,question_title,question_type,reward_member_count,reward_total_money,voteup_count	</div><div class="line">              columns.comments 	</div><div class="line">              columns.types boolean:string:string:string:string:string:string:string:string:string:string:smallint:boolean:int:string:string:boolean:boolean:boolean:boolean:string:string:string:string:int:int:int	</div><div class="line">              file.inputformat org.apache.hadoop.hive.ql.io.parquet.MapredParquetInputFormat	</div><div class="line">              file.outputformat org.apache.hadoop.hive.ql.io.parquet.MapredParquetOutputFormat	</div><div class="line">              location hdfs://device1:8020/user/hive/warehouse/zhihu.db/zhihu_answer_increment/ym=201902	</div><div class="line">              name zhihu.zhihu_answer_increment	</div><div class="line">              numFiles 256	</div><div class="line">              numRows 347468	</div><div class="line">              partition_columns ym	</div><div class="line">              partition_columns.types string	</div><div class="line">              rawDataSize 9381636	</div><div class="line">              serialization.ddl struct zhihu_answer_increment &#123; bool admin_closed_comment, string answer_content, string answer_created, string answer_id, string answer_updated, string author_headline, string author_id, string author_name, string author_type, string author_url_token, string avatar_url, i16 badge_num, bool can_comment, i32 comment_count, string gender, string insert_time, bool is_advertiser, bool is_collapsed, bool is_copyable, bool is_org, string question_created, string question_id, string question_title, string question_type, i32 reward_member_count, i32 reward_total_money, i32 voteup_count&#125;	</div><div class="line">              serialization.format 1	</div><div class="line">              serialization.lib org.apache.hadoop.hive.serde2.NullStructSerDe	</div><div class="line">              totalSize 433473813	</div><div class="line">              transient_lastDdlTime 1571983508	</div><div class="line">            serde: org.apache.hadoop.hive.serde2.NullStructSerDe	</div><div class="line">          	</div><div class="line">              input format: org.apache.hadoop.hive.ql.io.parquet.MapredParquetInputFormat	</div><div class="line">              output format: org.apache.hadoop.hive.ql.io.parquet.MapredParquetOutputFormat	</div><div class="line">              properties:	</div><div class="line">                bucket_count 256	</div><div class="line">                bucket_field_name answer_id	</div><div class="line">                columns admin_closed_comment,answer_content,answer_created,answer_id,answer_updated,author_headline,author_id,author_name,author_type,author_url_token,avatar_url,badge_num,can_comment,comment_count,gender,insert_time,is_advertiser,is_collapsed,is_copyable,is_org,question_created,question_id,question_title,question_type,reward_member_count,reward_total_money,voteup_count	</div><div class="line">                columns.comments 	</div><div class="line">                columns.types boolean:string:string:string:string:string:string:string:string:string:string:smallint:boolean:int:string:string:boolean:boolean:boolean:boolean:string:string:string:string:int:int:int	</div><div class="line">                file.inputformat org.apache.hadoop.hive.ql.io.parquet.MapredParquetInputFormat	</div><div class="line">                file.outputformat org.apache.hadoop.hive.ql.io.parquet.MapredParquetOutputFormat	</div><div class="line">                location hdfs://device1:8020/user/hive/warehouse/zhihu.db/zhihu_answer_increment	</div><div class="line">                name zhihu.zhihu_answer_increment	</div><div class="line">                partition_columns ym	</div><div class="line">                partition_columns.types string	</div><div class="line">                serialization.ddl struct zhihu_answer_increment &#123; bool admin_closed_comment, string answer_content, string answer_created, string answer_id, string answer_updated, string author_headline, string author_id, string author_name, string author_type, string author_url_token, string avatar_url, i16 badge_num, bool can_comment, i32 comment_count, string gender, string insert_time, bool is_advertiser, bool is_collapsed, bool is_copyable, bool is_org, string question_created, string question_id, string question_title, string question_type, i32 reward_member_count, i32 reward_total_money, i32 voteup_count&#125;	</div><div class="line">                serialization.format 1	</div><div class="line">                serialization.lib org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe	</div><div class="line">                transient_lastDdlTime 1571983018	</div><div class="line">              serde: org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe	</div><div class="line">              name: zhihu.zhihu_answer_increment	</div><div class="line">            name: zhihu.zhihu_answer_increment	</div><div class="line">      Truncated Path -&gt; Alias:	</div><div class="line">        nullscan://null/zhihu.zhihu_answer_increment/part_ym=201902_ [sq_1:zhihu_answer_increment]	</div><div class="line">      Needs Tagging: false	</div><div class="line">      Reduce Operator Tree:	</div><div class="line">        Group By Operator	</div><div class="line">          keys: KEY._col0 (type: string)	</div><div class="line">          mode: mergepartial	</div><div class="line">          outputColumnNames: _col0	</div><div class="line">          Statistics: Num rows: 1 Data size: 184 Basic stats: COMPLETE Column stats: COMPLETE	</div><div class="line">          Group By Operator	</div><div class="line">            keys: _col0 (type: string)	</div><div class="line">            mode: hash	</div><div class="line">            outputColumnNames: _col0	</div><div class="line">            Statistics: Num rows: 1 Data size: 184 Basic stats: COMPLETE Column stats: COMPLETE	</div><div class="line">            File Output Operator	</div><div class="line">              compressed: false	</div><div class="line">              GlobalTableId: 0	</div><div class="line">              directory: hdfs://device1:8020/tmp/hive/hive/7f0887a3-8c5a-44b6-b5ef-f0c7530a6b15/hive_2019-10-25_14-46-02_198_8962679143430564511-1/-mr-10004	</div><div class="line">              NumFilesPerFileSink: 1	</div><div class="line">              table:	</div><div class="line">                  input format: org.apache.hadoop.mapred.SequenceFileInputFormat	</div><div class="line">                  output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat	</div><div class="line">                  properties:	</div><div class="line">                    columns _col0	</div><div class="line">                    columns.types string	</div><div class="line">                    escape.delim \	</div><div class="line">                    serialization.lib org.apache.hadoop.hive.serde2.lazybinary.LazyBinarySerDe	</div><div class="line">                  serde: org.apache.hadoop.hive.serde2.lazybinary.LazyBinarySerDe	</div><div class="line">              TotalFiles: 1	</div><div class="line">              GatherStats: false	</div><div class="line">              MultiFileSpray: false	</div><div class="line">	</div><div class="line">  Stage: Stage-5	</div><div class="line">    Conditional Operator	</div><div class="line">	</div><div class="line">  Stage: Stage-6	</div><div class="line">    Map Reduce Local Work	</div><div class="line">      Alias -&gt; Map Local Tables:	</div><div class="line">        $INTNAME 	</div><div class="line">          Fetch Operator	</div><div class="line">            limit: -1	</div><div class="line">      Alias -&gt; Map Local Operator Tree:	</div><div class="line">        $INTNAME 	</div><div class="line">          TableScan	</div><div class="line">            GatherStats: false	</div><div class="line">            HashTable Sink Operator	</div><div class="line">              keys:	</div><div class="line">                0 ym (type: string)	</div><div class="line">                1 _col0 (type: string)	</div><div class="line">              Position of Big Table: 0	</div><div class="line">	</div><div class="line">  Stage: Stage-4	</div><div class="line">    Map Reduce	</div><div class="line">      Map Operator Tree:	</div><div class="line">          TableScan	</div><div class="line">            alias: zhihu_answer	</div><div class="line">            filterExpr: ym is not null (type: boolean)	</div><div class="line">            Statistics: Num rows: 102075765 Data size: 21537986328 Basic stats: COMPLETE Column stats: COMPLETE	</div><div class="line">            GatherStats: false	</div><div class="line">            Map Join Operator	</div><div class="line">              condition map:	</div><div class="line">                   Left Semi Join 0 to 1	</div><div class="line">              keys:	</div><div class="line">                0 ym (type: string)	</div><div class="line">                1 _col0 (type: string)	</div><div class="line">              Position of Big Table: 0	</div><div class="line">              Statistics: Num rows: 4253156 Data size: 0 Basic stats: PARTIAL Column stats: COMPLETE	</div><div class="line">              Group By Operator	</div><div class="line">                aggregations: count(1)	</div><div class="line">                mode: hash	</div><div class="line">                outputColumnNames: _col0	</div><div class="line">                Statistics: Num rows: 1 Data size: 8 Basic stats: COMPLETE Column stats: COMPLETE	</div><div class="line">                File Output Operator	</div><div class="line">                  compressed: false	</div><div class="line">                  GlobalTableId: 0	</div><div class="line">                  directory: hdfs://device1:8020/tmp/hive/hive/7f0887a3-8c5a-44b6-b5ef-f0c7530a6b15/hive_2019-10-25_14-46-02_198_8962679143430564511-1/-mr-10003	</div><div class="line">                  NumFilesPerFileSink: 1	</div><div class="line">                  table:	</div><div class="line">                      input format: org.apache.hadoop.mapred.SequenceFileInputFormat	</div><div class="line">                      output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat	</div><div class="line">                      properties:	</div><div class="line">                        columns _col0	</div><div class="line">                        columns.types bigint	</div><div class="line">                        escape.delim \	</div><div class="line">                        serialization.lib org.apache.hadoop.hive.serde2.lazybinary.LazyBinarySerDe	</div><div class="line">                      serde: org.apache.hadoop.hive.serde2.lazybinary.LazyBinarySerDe	</div><div class="line">                  TotalFiles: 1	</div><div class="line">                  GatherStats: false	</div><div class="line">                  MultiFileSpray: false	</div><div class="line">      Local Work:	</div><div class="line">        Map Reduce Local Work	</div><div class="line">      Path -&gt; Alias:	</div><div class="line">        hdfs://device1:8020/user/hive/warehouse/zhihu.db/zhihu_answer/ym=201705 [zhihu_answer]	</div><div class="line">        hdfs://device1:8020/user/hive/warehouse/zhihu.db/zhihu_answer/ym=201706 [zhihu_answer]	</div><div class="line">        hdfs://device1:8020/user/hive/warehouse/zhihu.db/zhihu_answer/ym=201707 [zhihu_answer]	</div><div class="line">        hdfs://device1:8020/user/hive/warehouse/zhihu.db/zhihu_answer/ym=201708 [zhihu_answer]	</div><div class="line">        hdfs://device1:8020/user/hive/warehouse/zhihu.db/zhihu_answer/ym=201709 [zhihu_answer]	</div><div class="line">        hdfs://device1:8020/user/hive/warehouse/zhihu.db/zhihu_answer/ym=201710 [zhihu_answer]	</div><div class="line">        hdfs://device1:8020/user/hive/warehouse/zhihu.db/zhihu_answer/ym=201711 [zhihu_answer]	</div><div class="line">        hdfs://device1:8020/user/hive/warehouse/zhihu.db/zhihu_answer/ym=201712 [zhihu_answer]	</div><div class="line">        hdfs://device1:8020/user/hive/warehouse/zhihu.db/zhihu_answer/ym=201801 [zhihu_answer]	</div><div class="line">        hdfs://device1:8020/user/hive/warehouse/zhihu.db/zhihu_answer/ym=201802 [zhihu_answer]	</div><div class="line">        hdfs://device1:8020/user/hive/warehouse/zhihu.db/zhihu_answer/ym=201803 [zhihu_answer]	</div><div class="line">        hdfs://device1:8020/user/hive/warehouse/zhihu.db/zhihu_answer/ym=201804 [zhihu_answer]	</div><div class="line">        hdfs://device1:8020/user/hive/warehouse/zhihu.db/zhihu_answer/ym=201805 [zhihu_answer]	</div><div class="line">        hdfs://device1:8020/user/hive/warehouse/zhihu.db/zhihu_answer/ym=201806 [zhihu_answer]	</div><div class="line">        hdfs://device1:8020/user/hive/warehouse/zhihu.db/zhihu_answer/ym=201807 [zhihu_answer]	</div><div class="line">        hdfs://device1:8020/user/hive/warehouse/zhihu.db/zhihu_answer/ym=201808 [zhihu_answer]	</div><div class="line">        hdfs://device1:8020/user/hive/warehouse/zhihu.db/zhihu_answer/ym=201809 [zhihu_answer]	</div><div class="line">        hdfs://device1:8020/user/hive/warehouse/zhihu.db/zhihu_answer/ym=201810 [zhihu_answer]	</div><div class="line">        hdfs://device1:8020/user/hive/warehouse/zhihu.db/zhihu_answer/ym=201811 [zhihu_answer]</div></pre></td></tr></table></figure></p>
<p>一脸懵逼，不会看呀。。<br>然后我测试了下单独执行：<code>select distinct(ym) from zhihu_answer_increment;</code>，也就不到2分钟就出结果了。为什么组合在一起就要这么长时间呢？？<br>这条SQL的执行结果就是<code>&quot;201902&quot;</code>。我把这个结果复制进去执行：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">from</span> zhihu_answer <span class="keyword">where</span> ym <span class="keyword">in</span> (<span class="number">201902</span>);</div></pre></td></tr></table></figure></p>
<p>可能是因为我之前执行过的原因，这条语句的执行时间基本上是秒出呀。几秒内就出结果了。</p>
<p>我再一次执行了那句执行时间很长的SQL，看它的执行时候的log，我发现慢原因是在Stage-4 ！！！回到上面那个explain的信息，我发现Hive在做全表扫描呀！Why?<br>为什么要做全表扫描呢？ 因为Hive还是要join的 in （select ** ） 这种子查询中用的是semi join，所以要进行join，它就会进行全表扫描。我的解释不是很详细，<br>但隐隐约约我能理解为什么Hive在这要做全表扫描了，其实如果写死的话，比如where ym in （201902）它就不会做join，也就不用全表扫描了。所以解决方案还是要能<br>拿到 <code>201902</code>这个变量，这个value，再拼接到Hive SQL中。我查了下，Hive貌似目前还不支持以SQL查询结果作为新的SQL变量。所以，暂时还是以这种办法解决吧。</p>
<p>让我无比开心的是，改进后，SQL执行快了N倍，因为避免了全表扫描。从原来2个小时的执行，变为了几分钟！</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通过Explain打印看看执行计划有哪些；<br>通过执行的log看看到底是哪个Stage耗时比较长；</p>
<h1 id="Referrence"><a href="#Referrence" class="headerlink" title="Referrence"></a>Referrence</h1><p><a href="https://docs.cloudera.com/documentation/enterprise/latest/topics/admin_hos_oview.html#concept_i22_l1h_1v" target="_blank" rel="external">https://docs.cloudera.com/documentation/enterprise/latest/topics/admin_hos_oview.html#concept_i22_l1h_1v</a></p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Dennis
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://mikolaje.github.io/2018/hive_optimization.html" title="Hive 优化">http://mikolaje.github.io/2018/hive_optimization.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/hive/" rel="tag"># hive</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/kafka_intro.html" rel="next" title="Kafka Introduction">
                <i class="fa fa-chevron-left"></i> Kafka Introduction
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/ubuntu_shared_object.html" rel="prev" title="Ubuntu的.so文件问题">
                Ubuntu的.so文件问题 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- side -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-9293695697921628"
     data-ad-slot="4837815018"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

		  


          


  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  

  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Dennis</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">35</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a rel="external nofollow" href="https://github.com/mikolaje" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a rel="external nofollow" href="https://www.zhihu.com/people/mikolaj" target="_blank" title="Zhihu">
                      
                        <i class="fa fa-fw fa-zhihu"></i>Zhihu</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a rel="external nofollow" href="https://stackoverflow.com/users/6169688/dennisli" target="_blank" title="StackOverflow">
                      
                        <i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a>
                  </span>
                
            </div>
          

          
          

          
          

          
        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Dynamic-Partition-Pruning-for-Hive-Map-Joins"><span class="nav-number">1.</span> <span class="nav-text">Dynamic Partition Pruning for Hive Map Joins</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#一次调优实战"><span class="nav-number"></span> <span class="nav-text">一次调优实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">1.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Referrence"><span class="nav-number"></span> <span class="nav-text">Referrence</span></a></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Dennis</span>

  
</div>


  <div class="powered-by">由 <a rel="external nofollow" class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a rel="external nofollow" class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://mikolaje.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://mikolaje.github.io/2018/hive_optimization.html';
          this.page.identifier = '2018/hive_optimization.html';
          this.page.title = 'Hive 优化';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://mikolaje.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  





  

  

  

  
  

  

  

  

</body>
</html>
